name: ğŸš€ Deploy the Mighty Contract API ğŸš€

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‰ Checkout the glorious code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21 (Because Java is life)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸ”¨ Build with Maven (Skip the boring tests)
        run: mvn clean install -DskipTests

      - name: ğŸ” Find the sacred JAR file
        id: find-jar
        run: |
          JAR_FILE=$(find ./target -name "*.jar" | head -n 1)
          echo "JAR_FILE_PATH=$JAR_FILE" >> $GITHUB_ENV
          echo "ğŸ” Found JAR file: $JAR_FILE"

      - name: ğŸ›  Install missing warriors (rsync and sshpass)
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync sshpass

      - name: ğŸ›¡ Fetch server host key (because security matters)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          echo "ğŸ”‘ Trust established with ${{ secrets.SERVER_IP }}"

      - name: ğŸš€ Deploy using rsync (Speedrun edition)
        run: |
          echo "ğŸ”¥ Deploying contract-api.jar to the battlefield..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" rsync -avz --compress-level=9 --omit-dir-times \
            -e "ssh -p ${{ secrets.SSH_PORT }}" \
            ${{ env.JAR_FILE_PATH }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/root/build/contract-api.jar
          echo "âœ… Deployment complete! The JAR has landed!"

      - name: ğŸ§ Verify JAR on server (Because trust issues)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ•µï¸ Checking if the JAR survived the journey..."
            echo "JAR file size on server: $(du -h /root/build/contract-api.jar)"
            echo "JAR file contents preview:"
            jar tf /root/build/contract-api.jar | head -n 10
            echo "âœ… JAR looks good!"

      - name: ğŸ”“ Set file permissions (Because Linux likes control)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ”§ Adjusting permissions for contract-api.jar"
            sudo chmod 644 /root/build/contract-api.jar
            sudo chown root:root /root/build/contract-api.jar
            echo "âœ… Permissions updated!"

      - name: ğŸ”„ Restart Contract API (Brace yourself...)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ’€ Killing the old process..."
            sudo systemctl daemon-reload
            sudo systemctl restart contract-api
            echo "ğŸš€ The new contract-api is rising from the ashes!"
            sudo systemctl status contract-api --no-pager
            echo "ğŸ‰ API is ALIVE! Time to celebrate! ğŸ‰"

      - name: ğŸ–¼ï¸ Pre-deployment Meme Motivation (Optional but fun)
        run: |
          echo "ğŸ”´ STOP! Before we continue, take a deep breath."
          echo "Here's some motivation for you: https://i.imgur.com/ZF7YhIj.jpg"
          echo "Now, let's ship it! ğŸš€"

      - name: ğŸ¥³ Send Slack Notification on Success
        if: success()
        uses: rtCamp/action-slack-notify@v2.3.2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: "#deployments"
          SLACK_USERNAME: "GitHub Actions"
          SLACK_MESSAGE: |
            ğŸ‰ *Contract API Deployment: SUCCESS!* ğŸš€
            âœ… *Everything went smoothly! Time to grab a coffee! â˜•*
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* `${{ github.sha }}`
            *Deployed by:* ${{ github.actor }}
            *Server:* `${{ secrets.SERVER_IP }}`
            ğŸ•º *Now do a little dance to celebrate!*
            https://giphy.com/gifs/party-dance-dancing-xT9Igo6YzPZSdTqdVu
          SLACK_COLOR: "good"

      - name: ğŸ¤¬ Send Slack Notification on Failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2.3.2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: "#deployments"
          SLACK_USERNAME: "GitHub Actions"
          SLACK_MESSAGE: |
            ğŸ˜¡ *Deployment Failed!* ğŸš¨
            âŒ Something went horribly wrong!
            *Repository:* ${{ github.repository }}
            *Branch:* ${{ github.ref_name }}
            *Commit:* `${{ github.sha }}`
            *Blame:* ${{ github.actor }} (jk... or maybe not ğŸ¤”)
            *Server:* `${{ secrets.SERVER_IP }}`
            ğŸš‘ *Check logs in GitHub Actions!*
            https://giphy.com/gifs/disaster-explosion-fire-3o7TKU8RvQuomFfUUU
          SLACK_COLOR: "danger"

      - name: ğŸ’ƒ Celebrate (Only if successful)
        if: success()
        run: |
          echo "ğŸŠğŸ‰ Deployment was a success! Time for a victory dance! ğŸ•ºğŸ’ƒ"
          echo "https://giphy.com/gifs/party-dance-dancing-xT9Igo6YzPZSdTqdVu"
